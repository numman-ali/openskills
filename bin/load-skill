#!/usr/bin/env bash
# load-skill - Universal skill loader for AI coding agents
# Compatible with Anthropic SKILL.md format
# Works in: Claude Code, Cursor, Windsurf, Aider, and any agent with Bash support

set -euo pipefail

SKILL_NAME="${1:-}"

# List skills if no argument
if [ -z "$SKILL_NAME" ]; then
  echo "Available Skills:"
  echo ""

  # Check common skill directories
  SEARCH_DIRS=(
    ".agent/skills"
    ".claude/skills"
    "$HOME/.openskills"
  )

  for dir in "${SEARCH_DIRS[@]}"; do
    if [ -d "$dir" ]; then
      echo "$(basename "$dir") ($dir):"
      for skill_dir in "$dir"/*/; do
        if [ -f "$skill_dir/SKILL.md" ]; then
          name=$(basename "$skill_dir")
          desc=$(awk '/^description:/{found=1; sub(/^description: /, ""); print; next} found && /^[a-z]/ && !/^description/{exit}' "$skill_dir/SKILL.md" | tr '\n' ' ' | sed 's/  */ /g')

          printf "  %-20s %s\n" "$name" "$desc"
        fi
      done
      echo ""
    fi
  done

  echo "Usage: load-skill <skill-name>"
  echo ""
  echo "Install skills:"
  echo "  install-skill owner/repo              # From GitHub"
  echo "  install-skill https://git.../repo.git # From Git URL"
  exit 0
fi

# Find skill (check in priority order)
SKILL_PATH=""
BASE_DIR=""
SKILL_SOURCE=""

SEARCH_DIRS=(
  ".agent/skills/$SKILL_NAME"
  ".claude/skills/$SKILL_NAME"
  "$HOME/.openskills/$SKILL_NAME"
)

for dir in "${SEARCH_DIRS[@]}"; do
  if [ -f "$dir/SKILL.md" ]; then
    SKILL_PATH="$dir/SKILL.md"
    BASE_DIR="$dir"
    SKILL_SOURCE=$(dirname "$(dirname "$dir")")
    break
  fi
done

if [ -z "$SKILL_PATH" ]; then
  echo "Error: Skill '$SKILL_NAME' not found"
  echo ""
  echo "Searched:"
  for dir in "${SEARCH_DIRS[@]}"; do
    echo "  $dir"
  done
  echo ""
  echo "Install skills: install-skill owner/repo"
  exit 1
fi

# Extract metadata
SKILL_DESC=$(awk '/^description:/{found=1; sub(/^description: /, ""); print; next} found && /^[a-z]/ && !/^description/{exit}' "$SKILL_PATH" | tr '\n' ' ' | sed 's/  */ /g')

# Minimal header matching Claude Code format
echo "Loading: $SKILL_NAME"
echo "Base directory: $BASE_DIR"
echo ""

# Output skill content
cat "$SKILL_PATH"

echo ""
echo "Skill loaded: $SKILL_NAME"
